/**
 * description: live reload background run init
 * author: rehorn@vip.qq.com
 * date: 2012-04-22
 */(function(a,b){var c={get:function(a){return _setting[a]}},d="__live_reload_wraper__",e={toArr:function(a){return Array.prototype.slice.call(a)},getAbsUrl:function(b){if(!b)return"";if(/https{0,1}:\/\//.test(b))return b;var c=a.location.href,d=c.split("/");d.pop();var e=b.split("/"),f=[];return e.forEach(function(a){a===".."?d.pop():a!=="."&&d.push(a)}),d.join("/")},trim:function(a){return a.replace(/(^[\\s]*)|([\\s]*$)/g,"")},getElementDescription:function(a){var b=a.tagName.toLowerCase();a.hasAttribute("id")&&(b+="#"+a.getAttribute("id"));if(a.hasAttribute("class")){var c=a.getAttribute("class").split(" ");for(var d=0,e=c.length;d<e;d++)b+="."+this.trim(c[d])}return b},isCheckable:function(a){if(!a)return!1;if(!c.get("lr_skip_external"))return!0;var b=a.match(/^([^:\/?#]+:)?(?:\/\/([^\/?#]*))?([^?#]+)?(\?[^#]*)?(#.*)?/);return typeof b[1]=="string"&&b[1].length>0&&b[1].toLowerCase()!==location.protocol?!1:typeof b[2]=="string"&&b[2].length>0&&b[2].replace(new RegExp(":("+{"http:":80,"https:":443}[location.protocol]+")?$"),"")!==location.host?!1:!0}},f={css:function(a,b){for(var c in b)a.style[c]=b[c]},show:function(a){this.css(a,{display:"block"})},hide:function(a){this.css(a,{display:"none"})},isShow:function(a){return a.style.display!=="none"}},g={init:function(){console.log("injectScript startLiveReload init"),this.initEvents(),c.get("lr_enable_scrolly")&&this._adjustScroll()},initWatchList:function(){var a=this._parseLinks();chrome.extension.sendRequest({action:"initWatchList",data:a},function(a){console.log(a)})},initEvents:function(){var a=this,b=this.observer={onExtRequest:function(b,c,d){console.log("onExtRequest"),b.action==="reload"?(a._reload(b.item),console.log("reload")):b.action==="startLiveReload"&&(a.initWatchList(),console.log("initWatchList"))},onDocumentMouseOver:function(b){var c=b.target,d=c.getBoundingClientRect(),g=Math.max(document.documentElement.scrollTop,document.body.scrollTop),h=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft);f.css(a.wraper,{width:d.width+"px",height:d.height+"px",top:d.top+g+"px",left:d.left+h+"px",display:"block"}),a.idClassTag.innerHTML=e.getElementDescription(c),d.width<100?f.hide(a.escTag):f.show(a.escTag)},onDocumentKeyDown:function(b){b.keyCode==120&&c.get("lr_enable_F9")?a._reloadCss():b.keyCode==119&&c.get("lr_enable_tag")?a._toggleNodeWrapper():b.keyCode==27&&a._hideNodeWrapper()}};chrome.extension.onRequest.addListener(b.onExtRequest),document.addEventListener("keydown",b.onDocumentKeyDown,!1)},_parseLinks:function(){var a=e.toArr(document.querySelectorAll('link[href*=".css"]')),b=e.toArr(document.querySelectorAll('script[src*=".js"]')),d=document.URL,f=[];return c.get("lr_enable_css")&&a.forEach(function(a){var b=e.getAbsUrl(a.getAttribute("href"));if(e.isCheckable(b)){var c={type:"css",url:b};f.push(c)}}),c.get("lr_enable_js")&&b.forEach(function(a){var b=e.getAbsUrl(a.getAttribute("src"));if(e.isCheckable(b)){var c={type:"js",url:b};f.push(c)}}),c.get("lr_enable_html")&&e.isCheckable(d)&&f.push({type:"html",url:d}),f},_adjustScroll:function(){var b="__LiveRloadScrollY",c=new RegExp("(^| )"+b+"=([^;]*)(;|$)"),d=c.exec(document.cookie),e=d?d[2]:null;if(e==null)return;a.pageYOffset!=null&&(a.pageYOffset=e),document.documentElement.scrollTop!=null&&(document.documentElement.scrollTop=e),a.pageYOffset!=null&&(a.pageYOffset=e),document.body.scrollTop!=null&&(document.body.scrollTop=e)},_showNodeWrapper:function(){if(!this.wraper){var a=this.wraper=document.createElement("div");a.id=d,a.innerHTML='<div id="'+d+'tag" class="wraper-tag id-class-tag"></div><div id="'+d+'esc"  class="wraper-tag esc-tips">esc退出</div>',document.body.appendChild(a),this.idClassTag=document.querySelector("#"+d+"tag"),this.escTag=document.querySelector("#"+d+"esc"),f.hide(a)}document.addEventListener("mouseover",this.observer.onDocumentMouseOver,!1),this.isWrapperShow=!0},_hideNodeWrapper:function(){this.wraper&&(f.hide(this.wraper),document.removeEventListener("mouseover",this.observer.onDocumentMouseOver,!1)),this.isWrapperShow=!1},_toggleNodeWrapper:function(){this.isWrapperShow?this._hideNodeWrapper():this._showNodeWrapper()},_reload:function(a){console.log("reload "+a.url);var b=this;a.type=="css"?b._reloadCss():["js","html"].indexOf(a.type)>=0&&b._reloadPage()},_reloadCss:function(){var a=e.toArr(document.querySelectorAll('link[href*=".css"]')),b=new Date-0;a.forEach(function(a){a.setAttribute("href",a.getAttribute("href"))})},_reloadPage:function(){var b=a.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0;document.cookie="__LiveRloadScrollY="+b,location.reload()}};g.init()})(window);