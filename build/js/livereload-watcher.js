/**
 * description: live reload background run init
 * author: rehorn@vip.qq.com
 * date: 2012-04-22
 */(function(a,b){var c=a.LiveReloadSetting,d={uniqueArr:function(a,b){var c=a.length,d=a.slice(0),e,f;"function"!=typeof b&&(b=function(a,b){return a===b});while(--c>0){f=d[c],e=c;while(e--)if(b(f,d[e])){d.splice(c,1);break}}return d}},e=a.LiveReloadWatcher={_watchTabList:{},_cache:{},_requestList:{},init:function(){var a=this,b=c.get("lr_refresh_rate")||1e3;setInterval(function(){a._check()},b)},_check:function(){var a=this._getAllRequestList(),b=this;a.forEach(function(a){b._requestContent(a,function(c){b._cache.hasOwnProperty(a.url)&&b._cache[a.url]!==c&&b._fireCallback(a),b._cache[a.url]=c})})},_getAllRequestList:function(){var a=this,b=[];for(var c in a._watchTabList)a._watchTabList.hasOwnProperty(c)&&a._watchTabList[c].list.forEach(function(a){b.indexOf(a)===-1&&b.push(a)});return d.uniqueArr(b)},_requestContent:function(a,b){var c=a.url,d=new XMLHttpRequest;d.open("GET",c,!0),d.onreadystatechange=function(){d.readyState===4&&d.status===200&&b&&b(d.responseText)},d.send()},_fireCallback:function(a){for(var b in this._watchTabList)if(this._watchTabList.hasOwnProperty(b)){var c=this._watchTabList[b];if(c.list.indexOf(a)!==-1)try{c.callback(a)}catch(d){console.log("callback error")}}},add:function(a,b,c){var d=this;this._watchTabList[a]={list:b,callback:c},b.forEach(function(a){d._cache.hasOwnProperty(a.url)||d._requestContent(a,function(b){d._cache[a.url]=b,console.log("init "+a.url)})})},remove:function(a){delete this._watchTabList[a]}};e.init()})(window);